부하 테스트도 보고 APM도 보고 했지만, 운영체제에 대한 성능 지표를 더 잘 읽어야 함.

클라우드는 공유자원이다. 물리서버를 여러 개의 VM으로 나눠서 우리에게 나눠준 것. 클라우드는 하나의 물리머신의 자원을 나눠쓰는 것이기 때문에 같은 물리서버에 들어와 있는 다른 애가 점유율을 높여가면 우리 것에 영향이 있을 수 있음.

우리 서비스에서 오류가 났을 때 코드에 문제가 있는지, 클라우드에 문제가 있는지를 읽을 줄 알아야 한다. 클라우드 장애의 90% 는 디스크에서 발생.

또 알아야 하는 것 한가지. 우리에게 클라우드에서 4코어를 줬지만 사실 이건 가짜다. 아마존에서 주는 4코어와 다른 곳에서 주는 4코어가 다를 수 있다. 클라우드에서 4코어, 8코어는 별 의미가 없을 수 있다. 2코어가 4코어보다 성능이 좋을 수도 있다. 또 메모리는 최대 1.5배까지 뻥튀기가 가능하니(코어도 뻥튀기 가능) 우리에게 뻥튀기를 해서 주는 것일 수도 있다.

우리에게 계속 강조하시는 것은, 성능에 대한 지표를 읽을 수 있어야 한다. CPU 사용량, 메모리사용량, 디스크 사용량, 네트워크 사용량 전부 학교에서 중요하다고 배웠을 것이다.

운영체제적인 관점. 우리의 운영체제는 심플. 우리 컴퓨터의 자원사용은 프로세스가 점유한다. 자원 사용의 주체는 프로세스이고, 특정 프로세스가 문제가 생기면 많은 자원을 먹는 것. CPU 사용량은 cpu usage만 보면 안됨. cpu user, steal, irq 등등 많음. 이런 걸 잘 읽어야 함. CPU User는 우리가 짠 코드에서 자원을 먹는 것이다. CPU System은 커널 내부에서 먹는 것(많이 쓰이면 커널 내부에서 뭔가 이상한 일이 일어나는 것). CPU I/O Wait가 굉장히 중요하다.

CPU I/O Wait이 높으면 코드를 잘못 짰다는 것이다. 대용량 파일을 쓰고 적는 동안 CPU가 기다리고 있다는 것. 이건 멍청하게 짠 것. 우리는 논블로킹으로 짜야한다. 디스크에 파일 쓰고 나한테 나중에 콜백으로 알려줘로 해야하는데 I/O Wait이 높다는 건 대용량 파일을 write하면서 User level에서 기다리고 있다는 것이다.

CPU load를 먼저 읽어야 한다. 로드 개수는 cpu의 개수와 동일하다. max 값이 동일하다. 만약 cpu가 6개인데 load 값이 3이면 3개만 쓰고 있다는 뜻이다. 근데 만약 6개인데 load 값이 12개가 들어오면 부하가 더 들어왔다는 것을 의미한다.(우리가 가진 cpu보다)

클라우드에서 정말 중요한 게 CPU Steal 값이다. 호스트 머신이 우리 버추얼 머신까지 cpu를 할당하는 데 까지 걸리는 시간을 말한다. 이 값이 높다는 것은 우리가 입주한 호스트 머신에 무슨 일이 일어난 것이다. 이런 일이 일어난다면 vm을 이사해야한다. vm을 새로 만들라는 의미이다. 우리가 입주해있는 호스트 머신에 무슨 문제가 생긴 것.

IRQ는 인터럽트이다.

중요한 것은 I/O Wait와 Steal time을 눈여겨 봐라. 전자는 코드를 잘 못 짠 거고, 후자는 우리가 입주한 호스트에 문제가 난 것.

## 메모리

메모리 풀은 더이상 쓰지 않는 용어. Memory Available이라는 용어를 쓴다. 바로 줄 수 있는 메모리 양을 의미

Page Fault가 많이 발생한다는 것은 캐시 히트가 제대로 일어나지 않는다는 의미이다. 이 값이 높으면 캐시 미스가 많이 난다는 의미이다

## 디스크

디스크를 많이 봐야한다. 전체 클라우드 장애의 90%가 여기서 일어난다. 정말 잘 봐야한다.

Disk Usage보다는 Disk I/O를 눈여겨 봐야한다. 얘가 100%를 찼다는 것은 더이상 write를 못한다는 것.

IOPS가 굉장히 중요하다. 이 값이 특정 값 이상으로 못 올라가면 Queue Length가 올라가는데 이때가 장애가 발생한 시점이라고 생각하면 된다. 오류가 나서 다 튕겨내게 됨. 디스크 I/O를 더 준다거나 I/O를 적게 쓰게 코드를 짜야한다.

## 네트워크

패킷 in/out도 나오고 패킷 drop 도 다 나온다. 에러도 다 남음.

패킷 드랍이 있다는 것은 이유가 여러 가지이다. 우리 임계치 이상으로 패킷 들어온 경우. In할 때 패킷 드랍이 있으면 패킷이 들어오다 다 못들어온다는 것.

지표를 다 알필요는 없다. 딱 이정도만 알면 된다.

CPU 사용량에서 Load, Steal Time, Interrupt, I/O wait (htop으로 읽으면 됨)

메모리는 Page fault 위주로, 어베일러블 위주로

네트워크는 드랍/에러

디스크는 I/O 와 Queue length만 보면 된다.

소켓의 개수도 체크해야하지만 소켓의 상태를 체크하는 것이 더 중요하다. close wait인 애들을 체크하는 것이 중요하다.(소켓을 안닫고 나가는 것) 특정 개수 이상 넘어가면 안되지. socket status를 체크해야한다. 이거 위주로 보면 된다.
